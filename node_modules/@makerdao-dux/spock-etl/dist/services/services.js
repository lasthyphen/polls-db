"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createProvider = exports.withTx = exports.createServices = void 0;
const getNetworkState_1 = require("../ethereum/getNetworkState");
const RetryProvider_1 = require("../ethereum/RetryProvider");
const state_1 = require("../processors/state");
const config_1 = require("./config");
async function createServices(config, db) {
    const processorSchema = config.processorSchema;
    const extractedSchema = config.extractedSchema;
    const columnSets = db.getColumnSetsForChain(processorSchema, extractedSchema);
    const provider = createProvider(config.chain.host, config.chain.retries);
    const networkState = await getNetworkState_1.getNetworkState(provider);
    const processorsState = state_1.getInitialProcessorsState(config_1.getAllProcessors(config));
    const services = {
        ...db,
        config,
        provider,
        networkState,
        processorSchema,
        columnSets,
        processorsState,
    };
    return services;
}
exports.createServices = createServices;
async function withTx(services, op) {
    return await services.db.tx(async (tx) => {
        const txServices = {
            ...services,
            tx,
        };
        return await op(txServices);
    });
}
exports.withTx = withTx;
function createProvider(url, retries) {
    return new RetryProvider_1.RetryProvider(url, retries);
}
exports.createProvider = createProvider;
//# sourceMappingURL=services.js.map