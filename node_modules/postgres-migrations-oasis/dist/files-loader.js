"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const util_1 = require("util");
const migration_file_1 = require("./migration-file");
const readDir = util_1.promisify(fs.readdir);
const isValidFile = (fileName) => /.(sql|js)$/gi.test(fileName);
exports.load = async (directory, log, config) => {
    log(`Loading migrations from: ${directory}`);
    const fileNames = await readDir(directory);
    log(`Found migration files: ${fileNames}`);
    if (fileNames != null) {
        const migrationFiles = [
            ...fileNames.map(fileName => path.resolve(directory, fileName)),
        ].filter(isValidFile);
        const unorderedMigrations = await Promise.all(migrationFiles.map(migration_file_1.load));
        unorderedMigrations.push(migration_file_1.loadRaw("0_create-migrations-table.sql", `CREATE TABLE IF NOT EXISTS "${config.tableName}" (
      id integer PRIMARY KEY,
      name varchar(100) UNIQUE NOT NULL,
      hash varchar(40) NOT NULL, -- sha1 hex encoded hash of the file name and contents, to ensure it hasn't been altered since applying the migration
      executed_at timestamp DEFAULT current_timestamp
    );
    `));
        // Arrange in ID order
        return unorderedMigrations.sort((a, b) => a.id - b.id);
    }
    return [];
};
